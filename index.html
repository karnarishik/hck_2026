<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeRefine Pro</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0d1117; color: #e6edf3;
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh; padding: 32px 24px;
  }
  .header { display: flex; align-items: center; gap: 14px; margin-bottom: 28px; }
  .logo-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, #a855f7, #6366f1);
    border-radius: 10px; display: flex; align-items: center;
    justify-content: center; font-size: 22px;
    box-shadow: 0 0 22px rgba(168,85,247,0.4);
  }
  .logo-text {
    font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800;
    background: linear-gradient(90deg, #a855f7, #22d3ee);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .editor-wrap {
    background: #161b22; border: 1px solid #30363d;
    border-radius: 12px; overflow: hidden; margin-bottom: 20px;
    transition: border-color .2s, box-shadow .2s;
  }
  .editor-wrap:focus-within {
    border-color: #a855f7; box-shadow: 0 0 0 3px rgba(168,85,247,.18);
  }
  .editor-chrome {
    background: #0f1318; border-bottom: 1px solid #30363d;
    padding: 8px 16px; display: flex; align-items: center; gap: 7px;
  }
  .dot { width: 11px; height: 11px; border-radius: 50%; }
  .dr{background:#ff5f57;} .dy{background:#ffbd2e;} .dg{background:#28c840;}
  .chrome-label { font-size: 11px; color: #8b949e; margin-left: 8px; }
  textarea {
    width: 100%; background: transparent; border: none; outline: none;
    color: #e6edf3; font-family: 'JetBrains Mono', monospace;
    font-size: 14px; line-height: 1.75; padding: 16px;
    resize: vertical; min-height: 220px; caret-color: #a855f7;
  }
  .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 28px; }
  button {
    font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700;
    padding: 12px 22px; border-radius: 10px; border: none;
    cursor: pointer; transition: all .18s; letter-spacing: .02em;
  }
  .btn-primary {
    flex: 1; min-width: 200px;
    background: linear-gradient(135deg, #a855f7, #6366f1); color: #fff;
    box-shadow: 0 4px 16px rgba(168,85,247,.35);
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(168,85,247,.5); }
  .btn-sec { background: #161b22; color: #e6edf3; border: 1px solid #30363d; }
  .btn-sec:hover { border-color: #8b949e; background: #0f1318; }
  .btn-cyan {
    background: linear-gradient(135deg, #0891b2, #22d3ee); color: #0f1318; font-weight: 800;
    box-shadow: 0 4px 16px rgba(34,211,238,.25);
  }
  .btn-cyan:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(34,211,238,.4); }
  .panels { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media(max-width:680px){ .panels{ grid-template-columns:1fr; } }
  .panel { background: #161b22; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; }
  .panel-head {
    background: #0f1318; border-bottom: 1px solid #30363d;
    padding: 10px 16px; font-size: 11px; font-weight: 700;
    letter-spacing: .08em; display: flex; align-items: center; gap: 8px;
  }
  .panel-left  .panel-head { color: #a855f7; border-top: 2px solid #a855f7; }
  .panel-right .panel-head { color: #22d3ee; border-top: 2px solid #22d3ee; }
  .panel-body {
    padding: 16px; font-size: 13px; line-height: 1.75;
    min-height: 180px; white-space: pre-wrap; word-break: break-word;
  }
  .empty { color: #8b949e; font-style: italic; }
  .copy-mini {
    margin-left: auto; background: none; border: 1px solid #30363d;
    color: #8b949e; padding: 3px 10px; border-radius: 6px;
    font-size: 10px; cursor: pointer; font-family: monospace; font-weight: 400;
  }
  .copy-mini:hover { color: #e6edf3; border-color: #8b949e; }
  .badge { display: inline-block; padding: 2px 9px; border-radius: 20px; font-size: 10px; font-weight: 700; }
  .b-ok   { background: rgba(63,185,80,.15);  color: #3fb950; }
  .b-warn { background: rgba(240,197,90,.15); color: #f0c55a; }
  .b-err  { background: rgba(248,81,73,.15);  color: #f85149; }
  .rpt-ok   { color: #3fb950; }
  .rpt-warn { color: #f0c55a; }
  .rpt-err  { color: #f85149; }
  .rpt-tip  { color: #22d3ee; }
  .rpt-section { font-weight: 700; margin: 10px 0 5px; }
  .rpt-item    { padding-left: 14px; margin-bottom: 3px; color: #e6edf3; }
  #toast {
    position: fixed; bottom: 24px; right: 24px;
    background: #161b22; border: 1px solid #30363d; color: #3fb950;
    padding: 10px 18px; border-radius: 10px; font-size: 13px; font-weight: 600;
    transform: translateY(60px); opacity: 0; transition: all .25s; z-index: 999; pointer-events: none;
  }
  #toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>

<div class="header">
  <div class="logo-icon">üêç</div>
  <span class="logo-text">CodeRefine Pro</span>
</div>

<div class="editor-wrap">
  <div class="editor-chrome">
    <div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div>
    <span class="chrome-label">input.py / js / any language</span>
  </div>
  <textarea id="codeInput" spellcheck="false" placeholder="Paste your code here...">print('hi</textarea>
</div>

<div class="btn-row">
  <button class="btn-primary" onclick="refineCode()">‚ú® Refine &amp; Enhance</button>
  <button class="btn-sec"     onclick="clearAll()">üóë Clear All</button>
  <button class="btn-sec"     onclick="copyPageURL()">üîó Copy Page URL</button>
  <button class="btn-cyan"    onclick="copyMagicLink()">‚ö° Copy Magic Link</button>
</div>

<div class="panels">
  <div class="panel panel-left">
    <div class="panel-head">
      ‚ú® ENHANCED CODE
      <span id="codeBadge"></span>
      <button class="copy-mini" onclick="copyEnhanced()">copy</button>
    </div>
    <div class="panel-body" id="enhancedOut"><span class="empty">Cleaned code will appear here...</span></div>
  </div>
  <div class="panel panel-right">
    <div class="panel-head">
      üìä QUALITY REPORT
      <span id="reportBadge"></span>
    </div>
    <div class="panel-body" id="reportOut"><span class="empty">Ready for analysis.</span></div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CodeRefine Engine ‚Äî 100% offline, no API key
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function detectLanguage(code) {
  if (/^\s*(def |import |print\(|elif |self\.|from \w+ import)/m.test(code)) return 'python';
  if (/^\s*(function |const |let |var |=>|console\.|document\.)/m.test(code)) return 'javascript';
  if (/^\s*(<\?php|\$[a-zA-Z]|echo )/m.test(code)) return 'php';
  if (/#include|int main|std::|cout/.test(code)) return 'cpp';
  if (/public class|System\.out|import java/.test(code)) return 'java';
  return 'generic';
}

function refineCode() {
  const raw = document.getElementById('codeInput').value;
  if (!raw.trim()) { showToast('‚ö†Ô∏è Please enter some code first'); return; }

  const lang = detectLanguage(raw);
  const result = analyze(raw, lang);

  // ‚îÄ‚îÄ Enhanced panel ‚îÄ‚îÄ
  document.getElementById('enhancedOut').textContent = result.fixed;
  document.getElementById('codeBadge').innerHTML = badgeHTML(result.status);

  // ‚îÄ‚îÄ Report panel ‚îÄ‚îÄ
  let html = '';
  const sc = { ok:'rpt-ok', warnings:'rpt-warn', errors:'rpt-err' }[result.status];
  html += `<div class="${sc} rpt-section">üìù ${esc(result.summary)}</div>`;

  if (result.errors.length) {
    html += `<div class="rpt-section rpt-err">‚úó Errors Fixed (${result.errors.length}):</div>`;
    result.errors.forEach(e => { html += `<div class="rpt-item">‚Ä¢ ${esc(e)}</div>`; });
  }
  if (result.warnings.length) {
    html += `<div class="rpt-section rpt-warn">‚ö† Warnings (${result.warnings.length}):</div>`;
    result.warnings.forEach(w => { html += `<div class="rpt-item">‚Ä¢ ${esc(w)}</div>`; });
  }
  if (result.tips.length) {
    html += `<div class="rpt-section rpt-tip">üí° Tips:</div>`;
    result.tips.forEach(t => { html += `<div class="rpt-item">${esc(t)}</div>`; });
  }
  if (!result.errors.length && !result.warnings.length)
    html += `<div class="rpt-item rpt-ok">‚úì No issues found ‚Äî code looks great!</div>`;

  document.getElementById('reportOut').innerHTML = html;
  document.getElementById('reportBadge').innerHTML = badgeHTML(result.status);
}

// ‚îÄ‚îÄ Analysis engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function analyze(code, lang) {
  let fixed = code;
  const errors = [], warnings = [], tips = [];

  fixed = fixUnclosedStrings(fixed, errors);
  fixed = fixUnclosedBrackets(fixed, errors);

  if (lang === 'python') {
    fixed = fixPythonColons(fixed, errors);
    fixed = fixPythonIndent(fixed, warnings);
    tips.push('Use 4 spaces per indent level (PEP 8).');
    tips.push('Add docstrings to functions: """Description"""');
    if (!/^#!/.test(fixed)) tips.push('Consider adding a shebang: #!/usr/bin/env python3');
  }

  if (lang === 'javascript') {
    fixed = fixJSSemicolons(fixed, warnings);
    if (/console\.log/.test(fixed)) tips.push('Remove console.log() calls before production.');
    if (/var /.test(fixed)) tips.push('Replace var with const or let.');
    tips.push('Use === instead of == for strict equality.');
  }

  if (lang === 'cpp' || lang === 'java') {
    if (!/\/\/.*copyright|\/\*.*\*\//i.test(fixed)) tips.push('Add a file header comment with author and date.');
  }

  fixed = fixed.split('\n').map(l => l.trimEnd()).join('\n'); // trailing whitespace
  fixed = fixed.replace(/\n{3,}/g, '\n\n');                  // too many blank lines
  fixed = ensureNewlineAtEnd(fixed);

  // Long lines
  const longLines = fixed.split('\n').filter(l => l.length > 100);
  if (longLines.length) warnings.push(`${longLines.length} line(s) exceed 100 chars ‚Äî consider splitting.`);

  // TODO/FIXME
  if (/TODO|FIXME|HACK/i.test(fixed)) warnings.push('Found TODO/FIXME comment(s) that still need attention.');

  const status = errors.length ? 'errors' : warnings.length ? 'warnings' : 'ok';
  const summary = status === 'ok'
    ? 'Code is clean and well-formatted ‚úì'
    : status === 'errors'
    ? `Fixed ${errors.length} error(s). Review changes in the enhanced panel.`
    : `No syntax errors. ${warnings.length} style warning(s) detected.`;

  return { fixed, errors, warnings, tips, status, summary };
}

// ‚îÄ‚îÄ Fix functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function fixUnclosedStrings(code, errors) {
  return code.split('\n').map((line, i) => {
    const t = line.trimStart();
    if (t.startsWith('#') || t.startsWith('//') || t.startsWith('*')) return line;
    let inStr = null, j = 0;
    while (j < line.length) {
      const ch = line[j];
      if (ch === '\\') { j += 2; continue; }
      if (!inStr && (ch === '"' || ch === "'")) inStr = ch;
      else if (inStr === ch) inStr = null;
      j++;
    }
    if (inStr) {
      errors.push(`Line ${i+1}: Unclosed ${inStr==='"'?'double':'single'} quote ‚Äî closing quote added.`);
      return line + inStr;
    }
    return line;
  }).join('\n');
}

function fixUnclosedBrackets(code, errors) {
  const pairs = {'(':')', '[':']', '{':'}'};
  const closing = new Set([')', ']', '}']);
  const stack = [];
  let i = 0;
  while (i < code.length) {
    const ch = code[i];
    if (ch === '"' || ch === "'") {
      const q = ch; i++;
      while (i < code.length && code[i] !== q) { if (code[i]==='\\') i++; i++; }
    } else if (pairs[ch]) {
      stack.push(ch);
    } else if (closing.has(ch)) {
      if (stack.length && pairs[stack[stack.length-1]] === ch) stack.pop();
    }
    i++;
  }
  if (stack.length) {
    const toAdd = stack.map(c => pairs[c]).reverse().join('');
    stack.forEach(c => errors.push(`Unclosed '${c}' bracket ‚Äî '${pairs[c]}' appended at end.`));
    return code + toAdd;
  }
  return code;
}

function fixPythonColons(code, errors) {
  const re = /^\s*(if |elif |else\b|for |while |def |class |with |try\b|except\b|finally\b)/;
  return code.split('\n').map((line, i) => {
    if (re.test(line) && !/:\s*(#.*)?$/.test(line) && !line.trimEnd().endsWith('\\')) {
      errors.push(`Line ${i+1}: Missing ':' after block statement ‚Äî added.`);
      return line.trimEnd() + ':';
    }
    return line;
  }).join('\n');
}

function fixPythonIndent(code, warnings) {
  if (/\t/.test(code)) {
    warnings.push('Tabs found ‚Äî converted to 4 spaces (PEP 8).');
    return code.replace(/\t/g, '    ');
  }
  return code;
}

function fixJSSemicolons(code, warnings) {
  const lines = code.split('\n');
  let count = 0;
  const fixed = lines.map(line => {
    const t = line.trimEnd();
    const s = line.trimStart();
    if (
      /^(const|let|var|return|throw|break|continue)\s/.test(s) &&
      !t.endsWith(';') && !t.endsWith('{') && !t.endsWith(',') && !t.endsWith('(') &&
      t.length > 0 && !s.startsWith('//')
    ) { count++; return t + ';'; }
    return line;
  });
  if (count) warnings.push(`Added ${count} missing semicolon(s).`);
  return fixed.join('\n');
}

function ensureNewlineAtEnd(code) {
  return code.endsWith('\n') ? code : code + '\n';
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function badgeHTML(status) {
  const m = { ok:['b-ok','‚úì Clean'], warnings:['b-warn','‚ö† Warnings'], errors:['b-err','‚úó Errors Fixed'] };
  const [cls, label] = m[status] || m.errors;
  return `<span class="badge ${cls}">${label}</span>`;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

function clearAll() {
  document.getElementById('codeInput').value = '';
  document.getElementById('enhancedOut').innerHTML = '<span class="empty">Cleaned code will appear here...</span>';
  document.getElementById('reportOut').innerHTML   = '<span class="empty">Ready for analysis.</span>';
  document.getElementById('codeBadge').innerHTML   = '';
  document.getElementById('reportBadge').innerHTML = '';
}

function copyEnhanced() {
  const t = document.getElementById('enhancedOut').textContent;
  if (!t || t.includes('Cleaned code')) { showToast('‚ö†Ô∏è Nothing to copy yet'); return; }
  navigator.clipboard.writeText(t).then(() => showToast('‚úì Code copied!'));
}

function copyPageURL() {
  const code = encodeURIComponent(document.getElementById('codeInput').value);
  navigator.clipboard.writeText(location.href.split('?')[0] + '?code=' + code)
    .then(() => showToast('‚úì URL copied!'));
}

function copyMagicLink() {
  const t = document.getElementById('enhancedOut').textContent;
  if (!t || t.includes('Cleaned code')) { showToast('‚ö†Ô∏è Enhance code first!'); return; }
  navigator.clipboard.writeText(t).then(() => showToast('‚ö° Enhanced code copied!'));
}

// Load from URL param
const p = new URLSearchParams(location.search);
if (p.get('code')) document.getElementById('codeInput').value = decodeURIComponent(p.get('code'));
</script>
</body>
</html>
