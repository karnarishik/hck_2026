import { useState } from "react";

const COLORS = {
  bg: "#0d1117",
  surface: "#161b22",
  surface2: "#0f1318",
  border: "#30363d",
  purple: "#a855f7",
  cyan: "#22d3ee",
  text: "#e6edf3",
  muted: "#8b949e",
  green: "#3fb950",
  yellow: "#f0c55a",
  red: "#f85149",
};

function Badge({ status }) {
  const map = {
    ok: { bg: "rgba(63,185,80,0.15)", color: "#3fb950", label: "‚úì Clean" },
    warnings: { bg: "rgba(240,197,90,0.15)", color: "#f0c55a", label: "‚ö† Warnings" },
    errors: { bg: "rgba(248,81,73,0.15)", color: "#f85149", label: "‚úó Errors" },
  };
  const s = map[status] || map.errors;
  return (
    <span style={{
      background: s.bg, color: s.color,
      padding: "2px 10px", borderRadius: 20,
      fontSize: 10, fontWeight: 700, letterSpacing: "0.05em"
    }}>{s.label}</span>
  );
}

function Toast({ msg, show }) {
  return (
    <div style={{
      position: "fixed", bottom: 24, right: 24,
      background: COLORS.surface, border: `1px solid ${COLORS.border}`,
      color: COLORS.green, padding: "10px 18px", borderRadius: 10,
      fontSize: 13, fontWeight: 600, fontFamily: "monospace",
      transform: show ? "translateY(0)" : "translateY(60px)",
      opacity: show ? 1 : 0, transition: "all 0.25s", zIndex: 999,
    }}>{msg}</div>
  );
}

function Panel({ title, icon, accentColor, children, headerRight }) {
  return (
    <div style={{
      background: COLORS.surface, borderRadius: 12,
      border: `1px solid ${COLORS.border}`, overflow: "hidden", flex: 1,
    }}>
      <div style={{
        background: COLORS.surface2, borderBottom: `1px solid ${COLORS.border}`,
        borderTop: `2px solid ${accentColor}`,
        padding: "10px 16px", fontSize: 11, fontWeight: 700,
        letterSpacing: "0.08em", color: accentColor,
        display: "flex", alignItems: "center", gap: 8,
        fontFamily: "monospace",
      }}>
        {icon} {title}
        {headerRight && <span style={{ marginLeft: "auto" }}>{headerRight}</span>}
      </div>
      <div style={{
        padding: 16, fontSize: 13, lineHeight: 1.7,
        minHeight: 160, fontFamily: "monospace", color: COLORS.text,
        whiteSpace: "pre-wrap", wordBreak: "break-word",
      }}>
        {children}
      </div>
    </div>
  );
}

export default function CodeRefinePro() {
  const [code, setCode] = useState("print('hi')");
  const [enhanced, setEnhanced] = useState(null);
  const [report, setReport] = useState(null);
  const [status, setStatus] = useState(null);
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState({ show: false, msg: "" });

  function showToast(msg) {
    setToast({ show: true, msg });
    setTimeout(() => setToast({ show: false, msg: "" }), 2500);
  }

  async function refineCode() {
    if (!code.trim()) { showToast("‚ö†Ô∏è Please enter some code first"); return; }
    setLoading(true);
    setEnhanced(null); setReport(null); setStatus(null);

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: `You are a code quality tool. Analyze and fix this code. Respond ONLY with valid JSON (no markdown, no backticks):
{
  "enhanced": "<corrected code>",
  "status": "ok",
  "issues": ["list any issues found, or empty array if none"],
  "tips": ["improvement tips"],
  "summary": "one sentence summary"
}

Code:
${code}`
          }]
        })
      });

      const data = await response.json();
      const raw = data.content?.[0]?.text || "";
      const clean = raw.replace(/```json|```/g, "").trim();
      const result = JSON.parse(clean);

      setEnhanced(result.enhanced || code);
      setStatus(result.status || "ok");
      setReport(result);
    } catch (err) {
      setEnhanced("// Error processing code\n// " + err.message);
      setStatus("errors");
      setReport({ summary: "Analysis failed. Please try again.", issues: [], tips: [] });
    }

    setLoading(false);
  }

  function clearAll() {
    setCode(""); setEnhanced(null); setReport(null); setStatus(null);
  }

  function copyCode() {
    if (enhanced) {
      navigator.clipboard.writeText(enhanced).then(() => showToast("‚úì Code copied!"));
    }
  }

  function copyPageURL() {
    navigator.clipboard.writeText(window.location.href).then(() => showToast("‚úì URL copied!"));
  }

  function copyMagicLink() {
    if (!enhanced) { showToast("‚ö†Ô∏è Enhance code first!"); return; }
    navigator.clipboard.writeText(enhanced).then(() => showToast("‚ö° Magic link copied!"));
  }

  const btnBase = {
    fontFamily: "monospace", fontWeight: 700, fontSize: 13,
    padding: "13px 22px", borderRadius: 10, border: "none",
    cursor: "pointer", transition: "all 0.2s", letterSpacing: "0.02em",
  };

  return (
    <div style={{ background: COLORS.bg, minHeight: "100vh", padding: "32px 24px", fontFamily: "monospace" }}>
      {/* Header */}
      <div style={{ display: "flex", alignItems: "center", gap: 14, marginBottom: 28 }}>
        <div style={{
          width: 40, height: 40, background: "linear-gradient(135deg, #a855f7, #6366f1)",
          borderRadius: 10, display: "flex", alignItems: "center", justifyContent: "center",
          fontSize: 20, boxShadow: "0 0 20px rgba(168,85,247,0.3)",
        }}>üêç</div>
        <span style={{
          fontSize: 26, fontWeight: 800,
          background: "linear-gradient(90deg, #a855f7, #22d3ee)",
          WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent",
        }}>CodeRefine Pro</span>
      </div>

      {/* Input */}
      <div style={{
        background: COLORS.surface, border: `1px solid ${COLORS.border}`,
        borderRadius: 12, marginBottom: 20, overflow: "hidden",
      }}>
        <div style={{
          background: COLORS.surface2, borderBottom: `1px solid ${COLORS.border}`,
          padding: "8px 16px", fontSize: 11, color: COLORS.muted,
          display: "flex", alignItems: "center", gap: 8,
        }}>
          <span style={{ width: 10, height: 10, borderRadius: "50%", background: "#ff5f57", display: "inline-block" }} />
          <span style={{ width: 10, height: 10, borderRadius: "50%", background: "#ffbd2e", display: "inline-block" }} />
          <span style={{ width: 10, height: 10, borderRadius: "50%", background: "#28c840", display: "inline-block" }} />
          <span style={{ marginLeft: 8 }}>input.py</span>
        </div>
        <textarea
          value={code}
          onChange={e => setCode(e.target.value)}
          spellCheck={false}
          placeholder="// Paste your code here..."
          style={{
            width: "100%", background: "transparent", border: "none", outline: "none",
            color: COLORS.text, fontFamily: "monospace", fontSize: 14, lineHeight: 1.7,
            padding: 16, resize: "vertical", minHeight: 200, caretColor: COLORS.purple,
          }}
        />
      </div>

      {/* Buttons */}
      <div style={{ display: "flex", gap: 12, flexWrap: "wrap", marginBottom: 28 }}>
        <button
          onClick={refineCode}
          disabled={loading}
          style={{
            ...btnBase, flex: 1, minWidth: 180,
            background: loading ? "#6b46a0" : "linear-gradient(135deg, #a855f7, #6366f1)",
            color: "white", boxShadow: "0 4px 15px rgba(168,85,247,0.3)",
            opacity: loading ? 0.8 : 1,
          }}
        >
          {loading ? "‚è≥ Analyzing..." : "‚ú® Refine & Enhance"}
        </button>
        <button onClick={clearAll} style={{ ...btnBase, background: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.border}` }}>
          üóë Clear All
        </button>
        <button onClick={copyPageURL} style={{ ...btnBase, background: COLORS.surface, color: COLORS.text, border: `1px solid ${COLORS.border}` }}>
          üîó Copy Page URL
        </button>
        <button onClick={copyMagicLink} style={{
          ...btnBase, background: "linear-gradient(135deg, #0891b2, #22d3ee)",
          color: "#0f1318", boxShadow: "0 4px 15px rgba(34,211,238,0.25)",
        }}>
          ‚ö° Copy Magic Link
        </button>
      </div>

      {/* Panels */}
      <div style={{ display: "flex", gap: 20, flexWrap: "wrap" }}>
        <Panel
          title="ENHANCED CODE"
          icon="‚ú®"
          accentColor={COLORS.purple}
          headerRight={
            <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
              {status && <Badge status={status} />}
              {enhanced && (
                <button onClick={copyCode} style={{
                  background: "none", border: `1px solid ${COLORS.border}`,
                  color: COLORS.muted, padding: "3px 10px", borderRadius: 6,
                  fontSize: 10, cursor: "pointer", fontFamily: "monospace",
                }}>copy</button>
              )}
            </div>
          }
        >
          {enhanced
            ? <span style={{ color: COLORS.green }}>{enhanced}</span>
            : <span style={{ color: COLORS.muted, fontStyle: "italic" }}>
                {loading ? "‚è≥ Processing your code..." : "Cleaned code will appear here..."}
              </span>
          }
        </Panel>

        <Panel title="QUALITY REPORT" icon="üìä" accentColor={COLORS.cyan} headerRight={status && <Badge status={status} />}>
          {report
            ? <div>
                <div style={{ color: COLORS.cyan, fontWeight: 700, marginBottom: 12 }}>{report.summary}</div>
                {report.issues?.length > 0 && (
                  <div style={{ marginBottom: 12 }}>
                    <div style={{ color: COLORS.red, fontWeight: 700, marginBottom: 6 }}>Issues Found:</div>
                    {report.issues.map((i, idx) => (
                      <div key={idx} style={{ color: COLORS.text, paddingLeft: 12, marginBottom: 4 }}>‚Ä¢ {i}</div>
                    ))}
                  </div>
                )}
                {report.tips?.length > 0 && (
                  <div>
                    <div style={{ color: COLORS.yellow, fontWeight: 700, marginBottom: 6 }}>Tips:</div>
                    {report.tips.map((t, idx) => (
                      <div key={idx} style={{ color: COLORS.text, paddingLeft: 12, marginBottom: 4 }}>üí° {t}</div>
                    ))}
                  </div>
                )}
              </div>
            : <span style={{ color: COLORS.muted, fontStyle: "italic" }}>
                {loading ? "‚è≥ Analyzing code quality..." : "Ready for analysis."}
              </span>
          }
        </Panel>
      </div>

      <Toast msg={toast.msg} show={toast.show} />
    </div>
  );
}
